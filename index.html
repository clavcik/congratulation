<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>–§–æ—Ç–æ‚Äë–∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä ‚Äî –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π —Å–∞–π—Ç</title>
  <style>
    :root{
      --bg: #0b0b0f; --text:#e8e8ef; --muted:#999; --accent:#9b87f5; --ok:#68d391; --bad:#ef4444;
    }
    *{box-sizing:border-box}
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
    button,input{font:inherit}
    .center{display:flex;align-items:center;justify-content:center}
    .scene{position:relative;min-height:100dvh;padding:24px;display:none}
    .scene.active{display:block}
    .card{max-width:1080px;margin:0 auto;background:#101018;border:1px solid #1b1b26;border-radius:20px;box-shadow:0 10px 30px rgba(0,0,0,.35);padding:28px}
    .title{font-size:clamp(18px,2.8vw,30px);font-weight:700;margin:0 0 12px}
    .sub{color:var(--muted);margin:6px 0 18px}
    .row{display:flex;gap:16px;flex-wrap:wrap}
    .btn{background:linear-gradient(135deg,#7c3aed,#22d3ee);border:0;color:white;padding:10px 16px;border-radius:12px;cursor:pointer}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .ghost{background:transparent;border:1px solid #303046;color:#d7d7e9}

    /* ‚Äî‚Äî –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–º–æ–¥–∞–ª) ‚Äî‚Äî */
    .modal{position:fixed;inset:0;background:rgba(5,6,12,.75);backdrop-filter:blur(8px);display:flex;align-items:center;justify-content:center;z-index:1000}
    .modal-card{background:#0f1016;border:1px solid #242438;border-radius:18px;padding:24px;max-width:480px;width:92%}
    .modal h1{margin:0 0 8px;font-size:24px}
    .field{display:flex;gap:8px;margin-top:14px}
    .field input{flex:1;background:#141627;border:1px solid #2a2d46;border-radius:12px;padding:12px 14px;color:#fff;outline:none}

    /* ‚Äî‚Äî –ü–ê–ó–õ–´ ‚Äî‚Äî */
    .puzzle-wrap{display:grid;grid-template-columns:1fr;gap:18px}
    .stage{position:relative;aspect-ratio:1/1;background:#0b0b13;border:1px dashed #2a2a3a;border-radius:18px;overflow:hidden}
    .silhouette{position:absolute;inset:0;background-size:contain;background-repeat:no-repeat;background-position:center;filter:grayscale(1) contrast(.8) opacity(.45)}
    .board{position:relative;min-height:180px;border:1px dashed #2d2d3d;border-radius:14px;padding:12px;display:flex;flex-wrap:wrap;gap:10px;align-content:flex-start}
    .piece{position:absolute;touch-action:none;user-select:none;cursor:grab;transition:box-shadow .2s ease}
    .piece:active{cursor:grabbing;box-shadow:0 6px 16px rgba(0,0,0,.45)}
    .target{position:absolute;border:2px dashed rgba(255,255,255,.15);border-radius:10px;transform:translate(-50%, -50%);width:80px;height:80px}
    .snap{outline:2px solid rgba(103,232,249,.6);border-style:solid}
    .done-badge{position:absolute;top:10px;right:10px;background:#0f172a;color:#a7f3d0;border:1px solid #134e4a;padding:6px 10px;border-radius:999px;font-size:12px;display:none}
    .stage.completed .done-badge{display:block}

    /* ‚Äî‚Äî –ü–ï–ß–ê–¢–ù–ê–Ø –°–¶–ï–ù–ê ‚Äî‚Äî */
    .typewriter{font-family:"IBM Plex Mono",ui-monospace,Menlo,Consolas,monospace;font-size:clamp(16px,2.4vw,26px);line-height:1.5;white-space:pre-wrap;min-height:40vh}

    /* ‚Äî‚Äî –°–¶–ï–ù–ê –° –°–ö–û–ë–û–ß–ö–ê–ú–ò ‚Äî‚Äî */
    .flood{font:700 clamp(18px,3vw,40px)/1.2 ui-monospace,monospace;word-wrap:break-word}

    /* ‚Äî‚Äî –ß–Å–†–ù–´–ï –§–õ–ê–ì–ò ‚Äî‚Äî */
    .flags-area{position:relative;min-height:70vh;border:1px solid #24243a;border-radius:18px;overflow:hidden}
    .flag{position:absolute;cursor:pointer;user-select:none}

    /* ‚Äî‚Äî –§–û–ù–ê–†–ò–ö –ò –ö–û–¢–Ø–¢–ê ‚Äî‚Äî */
    .darkfield{position:relative;height:70vh;border-radius:18px;overflow:hidden;background:#000}
    .darkfield .mask{position:absolute;inset:0;background:radial-gradient(circle 90px at var(--x,50%) var(--y,50%), rgba(255,255,255,.12), rgba(0,0,0,.92) 60%) mix-blend:normal;pointer-events:none}
    .kitty{position:absolute;width:120px;height:auto;filter:grayscale(1) brightness(.85);cursor:pointer}
    .tooltip{position:absolute;padding:6px 10px;background:#111827;border:1px solid #374151;border-radius:10px;font-size:12px;transform:translate(-50%, -120%);white-space:nowrap;display:none}

    /* ‚Äî‚Äî –ó–í–Å–ó–î–´ –ò –°–û–ó–í–ï–ó–î–ò–Ø ‚Äî‚Äî */
    .sky{position:relative;height:76vh;border-radius:18px;background:radial-gradient(1200px 600px at 60% -10%,#1b1d3a,#090a14 60%,#04050a 100%);overflow:hidden}
    .star{position:absolute;width:2px;height:2px;background:#fff;border-radius:50%;opacity:.9}
    .star:hover::after{content:attr(data-tip);position:absolute;left:10px;top:-6px;background:#0b1020;border:1px solid #1f2a44;padding:6px 8px;border-radius:8px;font-size:12px;color:#dbeafe;white-space:nowrap}
    .constellation{position:absolute;pointer-events:auto}
    .constellation path{stroke:#a78bfa;stroke-width:2;fill:none;filter:drop-shadow(0 0 6px rgba(167,139,250,.5))}
    .constellation:hover::after{content:attr(data-label);position:absolute;left:6px;top:-22px;background:#0f1020;border:1px solid #262b5a;padding:6px 8px;border-radius:8px;font-size:12px;color:#e9d5ff}
    .boom{position:absolute;inset:0;pointer-events:none}

    /* ‚Äî‚Äî –°–ê–õ–Æ–¢–´ –ò –§–ò–ù–ê–õ ‚Äî‚Äî */
    .fireworks{position:relative;height:70vh;border-radius:18px;background:radial-gradient(800px 500px at 50% -10%,#111,#000)}
    .greet{font-size:clamp(18px,3.4vw,42px);text-align:center;margin-top:12px}
    .heart{display:inline-block;border:1px solid #1f2937;background:#0b0b0f;color:#fff;padding:8px 12px;border-radius:999px;cursor:pointer}
    .secret{margin-top:16px;display:none;text-align:center}

    /* helpers */
    .fade-enter{animation:fade .5s ease both}
    @keyframes fade{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  </style>
  <!--
  ‚öôÔ∏è –ö–∞–∫ –ø–æ–¥–∫–ª—é—á–∏—Ç—å —Å–≤–æ–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∏–∑ –∞—Ä—Ö–∏–≤–∞ 2.zip
  –†–∞–∑–ª–æ–∂–∏—Ç–µ —Ñ–∞–π–ª—ã —Ç–∞–∫ (–≤ —Ç–æ–π –∂–µ –ø–∞–ø–∫–µ, –≥–¥–µ HTML):
  assets/
    task1/
      silhouette.png            ‚Äî –ø–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω—ã–π —Å–∏–ª—É—ç—Ç –¥–ª—è –ø–∞–∑–ª–∞ ‚Ññ1
      pieces/
        p1.png p2.png p3.png p4.png ... ‚Äî —á–∞—Å—Ç–∏ —Ç–µ–ª–∞
    task2/ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
    task3/ (–∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ)
  –ö–æ—Ç—è—Ç–∞:
    assets/kittens/black.png, assets/kittens/white.png (–∏–ª–∏ –ª—é–±—ã–µ –≤–∞—à–∏ –∏–º–µ–Ω–∞ ‚Äî –ø–æ–ø—Ä–∞–≤—å—Ç–µ –ø—É—Ç–∏ –≤ CONFIG –Ω–∏–∂–µ)
  –í—Å–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã —Ü–µ–ª–µ–π –∑–∞–¥–∞–Ω—ã –≤ –ø—Ä–æ—Ü–µ–Ω—Ç–∞—Ö ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –ø–æ–¥—Å—Ç—Ä–æ–π—Ç–µ –≤ PUZZLES_CONFIG.
  -->
</head>
<body>
  <!-- –ú–æ–¥–∞–ª: –≤–≤–æ–¥ –∏–º–µ–Ω–∏ -->
  <div id="nameModal" class="modal">
    <div class="modal-card">
      <h1>–ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ —Ç–µ–±—è –∑–æ–≤—É—Ç? üôÇ</h1>
      <p class="sub">–ò–º—è –Ω—É–∂–Ω–æ –æ–¥–∏–Ω —Ä–∞–∑ ‚Äî —á—Ç–æ–±—ã –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ.</p>
      <div class="field">
        <input id="nameInput" type="text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∏–º—è" maxlength="24" />
        <button class="btn" id="nameGo">–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å</button>
      </div>
    </div>
  </div>

  <!-- –°—Ü–µ–Ω–∞ 1‚Äì3: –ø–∞–∑–ª—ã -->
  <section class="scene active" id="scene-puzzles">
    <div class="card">
      <h2 class="title">–°–æ–±–µ—Ä–∏ —Ñ–æ—Ç–æ –ø–æ —á–∞—Å—Ç—è–º</h2>
      <p class="sub">–ü–µ—Ä–µ—Ç–∞—Å–∫–∏–≤–∞–π —ç–ª–µ–º–µ–Ω—Ç—ã –Ω–∞ —Å–∏–ª—É—ç—Ç. –ù—É–∂–Ω–æ —Ä–µ—à–∏—Ç—å 3 –∑–∞–¥–∞–Ω–∏—è –ø–æ–¥—Ä—è–¥.</p>
      <div class="puzzle-wrap">
        <div class="stage" id="stage">
          <div class="done-badge">–ì–æ—Ç–æ–≤–æ ‚úì</div>
          <div class="silhouette" id="silhouette"></div>
          <!-- —Ü–µ–ª–∏ –∏ –∫—É—Å–æ—á–∫–∏ –ø–æ—è–≤—è—Ç—Å—è —Å–∫—Ä–∏–ø—Ç–æ–º -->
        </div>
        <div class="row">
          <button id="resetPuzzle" class="btn ghost">–°–±—Ä–æ—Å–∏—Ç—å –∑–∞–¥–∞–Ω–∏–µ</button>
          <button id="nextPuzzle" class="btn" disabled>–î–∞–ª—å—à–µ</button>
        </div>
        <p class="sub" id="puzzleProgress"></p>
      </div>
    </div>
  </section>

  <!-- –°—Ü–µ–Ω–∞ 4: –ø–µ—á–∞—Ç–Ω–∞—è –º–∞—à–∏–Ω–∫–∞ + ¬´)¬ª -->
  <section class="scene" id="scene-typewriter">
    <div class="card center" style="min-height:70vh;flex-direction:column;gap:16px">
      <div id="typewriter" class="typewriter"></div>
      <div id="flood" class="flood" style="display:none"></div>
    </div>
  </section>

  <!-- –°—Ü–µ–Ω–∞ 5: 6 —á—ë—Ä–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ -->
  <section class="scene" id="scene-flags">
    <div class="card">
      <h2 class="title">–ù–∞–π–¥–∏ 6 —á—ë—Ä–Ω—ã—Ö —Ñ–ª–∞–≥–æ–≤ üè¥</h2>
      <p class="sub">–° –∫–∞–∂–¥—ã–º –Ω–∞–π–¥–µ–Ω–Ω—ã–º —Ñ–ª–∞–≥–æ–º —Å–ª–µ–¥—É—é—â–∏–π –º–µ–ª—å—á–µ, –Ω–æ –∑–∞–º–µ—Ç–µ–Ω.</p>
      <div class="flags-area" id="flagsArea"></div>
      <div class="row" style="margin-top:12px;justify-content:space-between">
        <span class="sub">–û—Å—Ç–∞–ª–æ—Å—å: <b id="flagsLeft">6</b></span>
        <button id="flagsNext" class="btn" disabled>–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </section>

  <!-- –°—Ü–µ–Ω–∞ 6: —Ñ–æ–Ω–∞—Ä–∏–∫ –∏ –∫–æ—Ç—è—Ç–∞ -->
  <section class="scene" id="scene-kittens">
    <div class="card">
      <h2 class="title">–ù–∞–π–¥–∏ –Ω–∞—Å –≤–æ —Ç—å–º–µ</h2>
      <p class="sub">–î–≤–∏–≥–∞–π –∫—É—Ä—Å–æ—Ä ‚Äî —Å–≤–µ—Ç —Ñ–æ–Ω–∞—Ä–∏–∫–∞ –ø–æ–º–æ–∂–µ—Ç. –ù–∞–≤–µ–¥–∏ –Ω–∞ –∫–æ—Ç—è—Ç.</p>
      <div class="darkfield" id="darkfield">
        <img id="kittyBlack" class="kitty" alt="–ß—ë—Ä–Ω—ã–π –∫–æ—Ç—ë–Ω–æ–∫" />
        <img id="kittyWhite" class="kitty" alt="–ë–µ–ª—ã–π –∫–æ—Ç—ë–Ω–æ–∫" />
        <div id="kittyTip" class="tooltip">–≠—Ç–æ –º—ã</div>
        <div class="mask" id="mask"></div>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="kittensNext" class="btn" disabled>–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </section>

  <!-- –°—Ü–µ–Ω–∞ 7: –∑–≤—ë–∑–¥—ã, –†–∞–∫ –∏ –î–µ–≤–∞ -->
  <section class="scene" id="scene-stars">
    <div class="card">
      <h2 class="title">–ó–≤—ë–∑–¥–Ω–∞—è —Å—Ü–µ–Ω–∞ ‚ú®</h2>
      <p class="sub">–ù–∞–≤–æ–¥–∏ –Ω–∞ —Å–≤–æ–±–æ–¥–Ω—ã–µ –∑–≤—ë–∑–¥—ã ‚Äî –æ–Ω–∏ —à–µ–ø—á—É—Ç –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –¥–ª—è –Ø–Ω—ã. –ù–∞ —Å–æ–∑–≤–µ–∑–¥–∏—è—Ö –ø–æ–¥—Å–∫–∞–∑–∫–∏.</p>
      <div class="sky" id="sky">
        <!-- —Å–≤–æ–±–æ–¥–Ω—ã–µ –∑–≤—ë–∑–¥—ã –∏ –ø–æ–¥—Å–∫–∞–∑–∫–∏ –¥–æ–±–∞–≤–∏—Ç —Å–∫—Ä–∏–ø—Ç -->
        <svg class="constellation" id="cancer" data-label="–≠—Ç–æ —è" viewBox="0 0 300 200" width="300" height="200" style="left:8%;top:18%">
          <path d="M20,150 L80,120 L150,100 L220,70 L280,40"/>
          <circle cx="20" cy="150" r="2" fill="#fff"/><circle cx="80" cy="120" r="2" fill="#fff"/>
          <circle cx="150" cy="100" r="2" fill="#fff"/><circle cx="220" cy="70" r="2" fill="#fff"/>
          <circle cx="280" cy="40" r="2" fill="#fff"/>
        </svg>
        <svg class="constellation" id="virgo" data-label="–≠—Ç–æ —Ç—ã" viewBox="0 0 300 220" width="320" height="220" style="right:6%;top:24%">
          <path d="M20,40 L90,60 L140,100 L190,80 L250,140 L290,200"/>
          <circle cx="20" cy="40" r="2" fill="#fff"/><circle cx="90" cy="60" r="2" fill="#fff"/>
          <circle cx="140" cy="100" r="2" fill="#fff"/><circle cx="190" cy="80" r="2" fill="#fff"/>
          <circle cx="250" cy="140" r="2" fill="#fff"/><circle cx="290" cy="200" r="2" fill="#fff"/>
        </svg>
        <canvas class="boom" id="boom"></canvas>
      </div>
      <div class="row" style="justify-content:flex-end;margin-top:12px">
        <button id="starsNext" class="btn" disabled>–î–∞–ª—å—à–µ</button>
      </div>
    </div>
  </section>

  <!-- –°—Ü–µ–Ω–∞ 8: —Ñ–∏–Ω–∞–ª —Å —Å–∞–ª—é—Ç–∞–º–∏ –∏ –ø–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ–º -->
  <section class="scene" id="scene-final">
    <div class="card">
      <div class="fireworks" id="fireworks"></div>
      <div class="greet" id="greet"></div>
      <p class="sub" style="text-align:center">–ù–∞–∂–º–∏ –Ω–∞ —á—ë—Ä–Ω–æ–µ —Å–µ—Ä–¥—Ü–µ ‚Üì</p>
      <div class="center">
        <button class="heart" id="heart">üñ§</button>
      </div>
      <div class="secret" id="secret">
        <div style="font-size:clamp(16px,2.2vw,28px);line-height:1.5">–Ø –¥–æ–ª–≥–æ –¥—É–º–∞–ª –∫–∞–∫ —Å–∫–∞–∑–∞—Ç—å, –∞ —Ç—ã –∑–Ω–∞–µ—à—å, —á—Ç–æ —è –ª—é–±–ª—é –µ—Å–ª–∏ –∏ –¥–µ–ª–∞—Ç—å –ø—Ä–æ—Å—Ç—ã–µ –≤–µ—â–∏(—Ç–∞–∫–∏–µ –∫–∞–∫ –ø—Ä–∏–∑–Ω–∞–Ω–∏–µ –≤ –ª—é–±–≤–∏), —Ç–æ —Å —Ä–∞–∑–º–∞—Ö–æ–º. –°—Ç–∞–Ω–µ—à—å –º–æ–µ–π –≥–æ—Ç–∫–æ–π –∏ —Å–æ–≥–ª–∞—Å–Ω–∞ –ª–∏ –≤—Å—Ç—É–ø–∏—Ç—å —Å–æ –º–Ω–æ–π –Ω–∞ —ç—Ç–æ—Ç –Ω–µ–ª–µ–≥–∫–∏–π –ø—É—Ç—å?üñ§</div>
      </div>
    </div>
  </section>

  <script>
    // ======== –ù–ê–°–¢–†–û–ô–ö–ò / –ö–û–ù–§–ò–ì ========
    const USER = { name: null };

    // –ü–∞–∑–ª—ã: –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –∑–∞–¥–∞–Ω–∏—è ‚Äî —Å–∏–ª—É—ç—Ç, —Å–ø–∏—Å–æ–∫ –∫—É—Å–∫–æ–≤ –∏ —Ü–µ–ª–µ–≤—ã–µ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã (–≤ % –æ—Ç –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞)
    // ‚ö†Ô∏è –ü–æ–¥—Å—Ç–∞–≤—å—Ç–µ —Å–≤–æ–∏ –ø—É—Ç–∏ –∏–∑ –∞—Ä—Ö–∏–≤–∞ 2.zip
    const PUZZLES_CONFIG = [
  {
    silhouette: 'assets/task1/1silhouette.png',
    pieces: [
      { src: 'assets/task1/p1/1body.png', w: 180, h: 180, target: { x: 45, y: 60 } },
      { src: 'assets/task1/p1/1head.png', w: 140, h: 140, target: { x: 47, y: 25 } },
      { src: 'assets/task1/p1/1leftarm.png', w: 150, h: 150, target: { x: 35, y: 55 } },
      { src: 'assets/task1/p1/1righarm.png', w: 150, h: 150, target: { x: 60, y: 55 } },
    ]
  },
  ];

    // –ö–æ—Ç—è—Ç–∞ (–ø—É—Ç–∏ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–∞–º)
    const KITTENS = {
      black: 'assets/kittens/black.png',
      white: 'assets/kittens/white.png'
    };

    // –ö–æ–º–ø–ª–∏–º–µ–Ω—Ç—ã –¥–ª—è –Ø–Ω—ã (–ø–æ–∫–∞–∑—ã–≤–∞—é—Ç—Å—è –Ω–∞ –∑–≤—ë–∑–¥–∞—Ö)
    const COMPLIMENTS = [
      '–Ø–Ω–∞, —Ç—ã —Å–∏—è–µ—à—å —è—Ä—á–µ –í–µ–≥–∏',
      '–Ø–Ω–∞, —Ç–≤–æ—è —É–ª—ã–±–∫–∞ ‚Äî –º–æ–π –ö–æ—Å–º–æ—Å',
      '–Ø–Ω–∞, —Å —Ç–æ–±–æ–π —Å–ø–æ–∫–æ–π–Ω–æ, –∫–∞–∫ –≤ –Ω–µ–≤–µ—Å–æ–º–æ—Å—Ç–∏',
      '–Ø–Ω–∞, —Ç—ã ‚Äî —Å–µ–≤–µ—Ä –¥–ª—è –º–æ–µ–≥–æ –∫–æ–º–ø–∞—Å–∞',
      '–Ø–Ω–∞, —Ä—è–¥–æ–º —Å —Ç–æ–±–æ–π –¥–∞–∂–µ —Ç—É–º–∞–Ω–Ω–æ—Å—Ç–∏ —Ç–∞—é—Ç',
      '–Ø–Ω–∞, —Ç–≤–æ—ë —Å–µ—Ä–¥—Ü–µ ‚Äî –º–æ—è –ì–∞–ª–∞–∫—Ç–∏–∫–∞',
      '–Ø–Ω–∞, —Ç—ã –ø—Ä–µ–∫—Ä–∞—Å–Ω–∞ –¥–æ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ—Å—Ç–∏',
      '–Ø–Ω–∞, —Ç—ã ‚Äî –º–æ—ë —Å—á–∞—Å—Ç–ª–∏–≤–æ–µ —Å–æ–∑–≤–µ–∑–¥–∏–µ'
    ];

    // ======== –£–¢–ò–õ–ò–¢–´ ========
    const $ = s => document.querySelector(s);
    const $$ = s => Array.from(document.querySelectorAll(s));
    const delay = ms => new Promise(r => setTimeout(r, ms));

    function showScene(id){ $$('.scene').forEach(sc=>sc.classList.remove('active')); $(id).classList.add('active'); }

    // ======== –ó–ê–ü–†–û–° –ò–ú–ï–ù–ò ========
    const modal = $('#nameModal'), nameInput = $('#nameInput'), nameGo = $('#nameGo');
    nameGo.addEventListener('click', ()=>{
      const v = nameInput.value.trim();
      if(!v) return nameInput.focus();
      USER.name = v;
      localStorage.setItem('userName', v);
      modal.remove();
      startPuzzles();
    });
    nameInput.addEventListener('keydown', e=>{ if(e.key==='Enter') nameGo.click(); });
    // –µ—Å–ª–∏ –∏–º—è —É–∂–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ ‚Äî –º–æ–∂–Ω–æ –∞–≤—Ç–æ–ø–æ–¥—Å—Ç–∞–≤–∏—Ç—å
    const saved = localStorage.getItem('userName');
    if(saved){ USER.name = saved; nameInput.value = saved; }

    // ======== –ü–ê–ó–õ–´ (3 –∑–∞–¥–∞–Ω–∏—è) ========
    let puzzleIndex = 0;
    const stage = $('#stage');
    const silhouette = $('#silhouette');
    const nextPuzzleBtn = $('#nextPuzzle');
    const resetPuzzleBtn = $('#resetPuzzle');
    const puzzleProgress = $('#puzzleProgress');

    function startPuzzles(){
      showScene('#scene-puzzles');
      loadPuzzle(puzzleIndex);
    }

    function loadPuzzle(idx){
      nextPuzzleBtn.disabled = true;
      stage.classList.remove('completed');
      stage.querySelectorAll('.piece,.target').forEach(n=>n.remove());
      const conf = PUZZLES_CONFIG[idx];
      silhouette.style.backgroundImage = `url('${conf.silhouette}')`;
      // –°–æ–∑–¥–∞—ë–º —Ü–µ–ª–∏
      conf.pieces.forEach((p, i)=>{
        const t = document.createElement('div');
        t.className = 'target';
        t.style.left = p.target.x + '%';
        t.style.top  = p.target.y + '%';
        t.dataset.i = i;
        stage.appendChild(t);
      });
      // –†–∞–∑–±—Ä–∞—Å—ã–≤–∞–µ–º –∫—É—Å–æ—á–∫–∏
      conf.pieces.forEach((p, i)=>{
        const img = document.createElement('img');
        img.className = 'piece';
        img.src = p.src; img.width = p.w; img.height = p.h;
        // —Å–ª—É—á–∞–π–Ω–∞—è –ø–æ–∑–∏—Ü–∏—è
        const rX = 10 + Math.random()*80;
        const rY = 10 + Math.random()*80;
        img.style.left = rX + '%';
        img.style.top  = rY + '%';
        img.dataset.i = i;
        makeDraggable(img);
        stage.appendChild(img);
      });
      updatePuzzleProgress();
    }

    function updatePuzzleProgress(){
      puzzleProgress.textContent = `–ó–∞–¥–∞–Ω–∏–µ ${puzzleIndex+1} –∏–∑ ${PUZZLES_CONFIG.length}`;
    }

    resetPuzzleBtn.addEventListener('click', ()=>loadPuzzle(puzzleIndex));
    nextPuzzleBtn.addEventListener('click', ()=>{
      puzzleIndex++;
      if(puzzleIndex < PUZZLES_CONFIG.length){
        loadPuzzle(puzzleIndex);
      } else {
        // –∫ –ø–µ—á–∞—Ç–Ω–æ–π —Å—Ü–µ–Ω–µ
        typewriterScene();
      }
    });

    function makeDraggable(el){
      let sx=0, sy=0, ox=0, oy=0, dragging=false, placed=false;
      const onDown = e=>{
        if(placed) return; dragging=true; el.style.zIndex=10; const pt = getPoint(e); sx = pt.x; sy = pt.y; const r = el.getBoundingClientRect(); ox = r.left; oy = r.top; e.preventDefault(); };
      const onMove = e=>{
        if(!dragging || placed) return; const pt = getPoint(e); const dx = pt.x - sx; const dy = pt.y - sy; el.style.left = (ox + dx - stage.getBoundingClientRect().left) + 'px'; el.style.top = (oy + dy - stage.getBoundingClientRect().top) + 'px'; };
      const onUp = ()=>{
        if(!dragging || placed) return; dragging=false; el.style.zIndex=1; // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –±–ª–∏–∂–∞–π—à—É—é —Ü–µ–ª—å
        const targets = $$('.target');
        let snapped = false;
        for(const t of targets){ if(t.dataset.i !== el.dataset.i) continue; // –ø—Ä–∞–≤–∏–ª—å–Ω–∞—è —Ü–µ–ª—å ‚Äî –ø–æ –∏–Ω–¥–µ–∫—Å—É
          const tr = t.getBoundingClientRect();
          const er = el.getBoundingClientRect();
          const dist = Math.hypot((er.left+er.width/2)-(tr.left+tr.width/2), (er.top+er.height/2)-(tr.top+tr.height/2));
          if(dist < 40){ // —Ä–∞–¥–∏—É—Å –∑–∞—Ö–≤–∞—Ç–∞
            // ¬´–ø—Ä–∏–ª–∏–ø–∞–Ω–∏–µ¬ª
            el.style.left = (tr.left + tr.width/2 - stage.getBoundingClientRect().left - el.width/2) + 'px';
            el.style.top  = (tr.top  + tr.height/2 - stage.getBoundingClientRect().top  - el.height/2) + 'px';
            el.classList.add('snap');
            placed = true; snapped = true; break;
          }
        }
        if(!snapped){ el.classList.remove('snap'); }
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è
        const allPlaced = $$('.piece').every(p=>p.classList.contains('snap'));
        if(allPlaced){ stage.classList.add('completed'); nextPuzzleBtn.disabled = false; }
      };
      el.addEventListener('mousedown', onDown); window.addEventListener('mousemove', onMove); window.addEventListener('mouseup', onUp);
      el.addEventListener('touchstart', e=>onDown(e.touches[0]), {passive:false});
      window.addEventListener('touchmove', e=>onMove(e.touches[0]), {passive:false});
      window.addEventListener('touchend', onUp);
    }
    function getPoint(e){ return { x: e.clientX, y: e.clientY }; }

    // ======== –°–¶–ï–ù–ê –ü–ï–ß–ê–¢–ù–û–ô –ú–ê–®–ò–ù–ö–ò + ¬´)¬ª ========
    async function typewriterScene(){
      showScene('#scene-typewriter');
      const tw = $('#typewriter');
      const flood = $('#flood');
      const text = '–¢—ã –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –¥—É–º–∞–µ—à—å, —á—Ç–æ —ç—Ç–æ –≤—Å—ë?';
      tw.textContent = '';
      const audio = $('#keySound');
      for(const ch of text){
        tw.textContent += ch;
        try{ audio.currentTime = 0; audio.play().catch(()=>{});}catch{}
        await delay(70);
      }
      await delay(700);
      // –ó–∞–ª–∏–≤–∫–∞ —Å–∫–æ–±–æ—á–∫–∞–º–∏
      tw.textContent = '';
      flood.style.display = 'block';
      const width = window.innerWidth; const height = window.innerHeight;
      const targetLen = Math.ceil((width*height)/5000); // –≥—Ä—É–±–∞—è –æ—Ü–µ–Ω–∫–∞
      let s = '';
      for(let i=0;i<targetLen;i++){ s += ')'; if(i%90===0) s+='\n'; }
      // –ë—ã—Å—Ç—Ä—ã–π –≤—ã–≤–æ–¥ –ø–∞—á–∫–∞–º–∏
      let idx=0;
      const chunk=60;
      await new Promise(res=>{
        const iv = setInterval(()=>{
          flood.textContent += s.slice(idx, idx+chunk);
          idx+=chunk;
          if(idx>=s.length){ clearInterval(iv); res(); }
        }, 12);
      });
      await delay(300);
      flagsScene();
    }

    // ======== –°–¶–ï–ù–ê –° –§–õ–ê–ì–ê–ú–ò ========
    function flagsScene() {
  showScene('#scene-flags');
  const area = $('#flagsArea');
  area.innerHTML = '';  // –û—á–∏—â–∞–µ–º –æ–±–ª–∞—Å—Ç—å —Å —Ñ–ª–∞–≥–∞–º–∏
  const leftEl = $('#flagsLeft');
  const next = $('#flagsNext');
  next.disabled = true;
  let count = 6;
  leftEl.textContent = count;

  for (let i = 0; i < 6; i++) {
    const span = document.createElement('span');
    span.className = 'flag fade-enter';
    span.textContent = 'üè¥';
    const size = 48 - i * 6;
    span.style.fontSize = size + 'px';
    span.style.left = (Math.random() * 90 + 3) + '%';
    span.style.top = (Math.random() * 80 + 8) + '%';

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –Ω–∞ —Ñ–ª–∞–≥
    span.addEventListener('click', () => {
      if (span.dataset.hit) return; // –ï—Å–ª–∏ —Ñ–ª–∞–≥ —É–∂–µ –Ω–∞–π–¥–µ–Ω, –Ω–µ —Ä–µ–∞–≥–∏—Ä—É–µ–º
      span.dataset.hit = '1';       // –û—Ç–º–µ—á–∞–µ–º —Ñ–ª–∞–≥ –∫–∞–∫ –Ω–∞–π–¥–µ–Ω–Ω—ã–π
      span.style.opacity = 0.25;    // –£–º–µ–Ω—å—à–∞–µ–º –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å —Ñ–ª–∞–≥–∞
      count--;                      // –£–º–µ–Ω—å—à–∞–µ–º —Å—á–µ—Ç—á–∏–∫ –æ—Å—Ç–∞–≤—à–∏—Ö—Å—è —Ñ–ª–∞–≥–æ–≤
      leftEl.textContent = count;

      // –£–±–∏—Ä–∞–µ–º —Ñ–ª–∞–≥ –∏–∑ –æ–±–ª–∞—Å—Ç–∏
      span.remove();                // –£–¥–∞–ª—è–µ–º —Ñ–ª–∞–≥ –∏–∑ DOM

      if (count === 0) next.disabled = false;
      playFlagClickSound(); // –ó–≤—É–∫ –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ —Ñ–ª–∞–∂–æ–∫
    });

    area.appendChild(span); // –î–æ–±–∞–≤–ª—è–µ–º —Ñ–ª–∞–≥ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
  }

  next.onclick = kittensScene;
}
    // ======== –°–¶–ï–ù–ê –§–û–ù–ê–†–ò–ö–ê –ò –ö–û–¢–Ø–¢ ========
    function kittensScene(){
      showScene('#scene-kittens');
      const field = $('#darkfield'); const mask = $('#mask'); const tip = $('#kittyTip');
      const kB = $('#kittyBlack'); const kW = $('#kittyWhite');
      kB.src = KITTENS.black; kW.src = KITTENS.white;
      // —Å–ª—É—á–∞–π–Ω–æ, –Ω–æ —Ä—è–¥–æ–º –¥—Ä—É–≥ —Å –¥—Ä—É–≥–æ–º
      const x = 40 + Math.random()*20; const y = 42 + Math.random()*16;
      kB.style.left = x+'%'; kB.style.top = y+'%';
      kW.style.left = (x+8)+'%'; kW.style.top = (y+2)+'%';
      const showTip = e=>{ tip.style.left = e.clientX+'px'; tip.style.top = e.clientY+'px'; tip.style.display='block'; };
      const hideTip = ()=>{ tip.style.display='none'; };
      [kB,kW].forEach(k=>{
        k.addEventListener('mousemove', showTip);
        k.addEventListener('mouseleave', hideTip);
        k.addEventListener('mouseenter', ()=>{ tip.textContent='–≠—Ç–æ –º—ã'; });
        k.addEventListener('click', ()=>{ $('#kittensNext').disabled=false; });
      });
      field.addEventListener('mousemove', e=>{
        const r = field.getBoundingClientRect();
        const x = ((e.clientX - r.left)/r.width*100).toFixed(2)+'%';
        const y = ((e.clientY - r.top)/r.height*100).toFixed(2)+'%';
        mask.style.setProperty('--x', x); mask.style.setProperty('--y', y);
      });
      $('#kittensNext').onclick = starsScene;
    }

    // ======== –°–¶–ï–ù–ê –ó–í–Å–ó–î –ò –°–û–ó–í–ï–ó–î–ò–ô ========
    function starsScene(){
      showScene('#scene-stars');
      const sky = $('#sky');
      // –°–≤–æ–±–æ–¥–Ω—ã–µ –∑–≤—ë–∑–¥—ã —Å –∫–æ–º–ø–ª–∏–º–µ–Ω—Ç–∞–º–∏
      for(let i=0;i<36;i++){
        const d = document.createElement('div'); d.className='star';
        d.style.left = (Math.random()*96+2)+'%'; d.style.top = (Math.random()*92+3)+'%';
        const tip = COMPLIMENTS[Math.floor(Math.random()*COMPLIMENTS.length)].replace('–Ø–Ω–∞', '–Ø–Ω–∞');
        d.dataset.tip = tip;
        sky.appendChild(d);
      }
      // –ê–Ω–∏–º–∞—Ü–∏—è —Å–±–ª–∏–∂–µ–Ω–∏—è –∏ –≤–∑—Ä—ã–≤
      let hitCancer=false, hitVirgo=false;
      const cancer = $('#cancer'); const virgo = $('#virgo'); const boom = $('#boom');
      const hover = (who)=>{ if(who==='c') hitCancer=true; else hitVirgo=true; check(); };
      cancer.addEventListener('mouseenter', ()=>hover('c'));
      virgo.addEventListener('mouseenter', ()=>hover('v'));
      function check(){
        if(hitCancer && hitVirgo){
          // –ø–ª–∞–≤–Ω–æ–µ —Å–±–ª–∏–∂–µ–Ω–∏–µ
          cancer.animate([{transform:'translateX(0)'},{transform:'translateX(80px)'}],{duration:900,fill:'forwards',easing:'ease-in-out'});
          virgo.animate([{transform:'translateX(0)'},{transform:'translateX(-80px)'}],{duration:900,fill:'forwards',easing:'ease-in-out'});
          setTimeout(()=>explode(boom), 950);
        }
      }
      $('#starsNext').disabled = true;
      boom.width = sky.clientWidth; boom.height = sky.clientHeight;
      function explode(cv){
        const ctx = cv.getContext('2d');
        const cx = cv.width/2, cy = cv.height/2; const parts=[];
        for(let i=0;i<220;i++){
          const a = Math.random()*Math.PI*2; const sp = 1+Math.random()*3; parts.push({x:cx,y:cy,dx:Math.cos(a)*sp,dy:Math.sin(a)*sp,life:60+Math.random()*40});
        }
        let t=0; const raf = ()=>{
          t++; ctx.fillStyle='rgba(0,0,0,0.18)'; ctx.fillRect(0,0,cv.width,cv.height);
          parts.forEach(p=>{ p.x+=p.dx; p.y+=p.dy; p.life--; ctx.fillStyle='rgba(255,255,255,.9)'; ctx.fillRect(p.x,p.y,2,2);});
          if(t<120) requestAnimationFrame(raf); else { $('#starsNext').disabled=false; }
        }; raf();
      }
      $('#starsNext').onclick = finalScene;
    }

    // ======== –§–ò–ù–ê–õ: –°–ê–õ–Æ–¢–´ + –ü–û–ó–î–†–ê–í–õ–ï–ù–ò–ï ========
    function finalScene(){
      showScene('#scene-final');
      const fw = $('#fireworks'); const greet = $('#greet');
      // –ü–æ–∑–¥—Ä–∞–≤–ª–µ–Ω–∏–µ
      const name = USER.name || localStorage.getItem('userName') || '–¥—Ä—É–≥';
      greet.innerHTML = `–ü—Ä–∏–¥—É–º–∞–ª–∞ –µ—â—ë ¬´${name}¬ª ‚Äî<br>–° –¥–Ω—ë–º —Ä–æ–∂–¥–µ–Ω–∏—è! –ü—É—Å—Ç—å —Å—á–∞—Å—Ç—å–µ –∏—Å–∫—Ä–∏—Ç—Å—è –≤ —Ç–≤–æ—ë–º –Ω–µ–±–µ. üñ§`;
      // –ü—Ä–æ—Å—Ç—ã–µ —Ñ–µ–π–µ—Ä–≤–µ—Ä–∫–∏ –Ω–∞ canvas
      const cv = document.createElement('canvas'); cv.width=fw.clientWidth; cv.height=fw.clientHeight; fw.appendChild(cv);
      const ctx = cv.getContext('2d');
      const sparks=[];
      function burst(){
        const x = Math.random()*cv.width, y = Math.random()*cv.height*0.5 + 40;
        for(let i=0;i<150;i++){
          const a = Math.random()*Math.PI*2; const sp = 1+Math.random()*3;
          sparks.push({x,y,dx:Math.cos(a)*sp,dy:Math.sin(a)*sp+0.5,life:80+Math.random()*40});
        }
      }
      setInterval(burst, 900); burst();
      (function anim(){
        ctx.fillStyle='rgba(0,0,0,0.22)'; ctx.fillRect(0,0,cv.width,cv.height);
        for(let i=sparks.length-1;i>=0;i--){ const p=sparks[i]; p.x+=p.dx; p.y+=p.dy; p.life--; if(p.life<=0) sparks.splice(i,1); else { ctx.fillStyle='rgba(255,255,255,.95)'; ctx.fillRect(p.x,p.y,2,2);} }
        requestAnimationFrame(anim);
      })();
      // –°–µ—Ä–¥—Ü–µ
      const heart = $('#heart'); const secret = $('#secret');
      heart.addEventListener('click', ()=>{ secret.style.display='block'; secret.classList.add('fade-enter'); });
    }
  </script>
</body>
</html>
